<!DOCTYPE html>
<html>
<head>
  <title>Airsoft QR Scanner</title>
  <style>
    body {
      background-color: black;
      color: red;
      font-family: monospace;
      overflow: hidden;
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }

    #confidential {
      font-size: 5vw;
      margin-top: 20px;
    }

    #countdown {
      font-size: 4vw;
      color: white;
      margin-top: 20px;
    }

    #data {
      font-size: 4vw;
      color: lime;
    }

    #qrCodeDisplay {
      font-size: 6vw;
      color: green;
      margin-top: 20px;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/UAParser.js/0.7.28/ua-parser.min.js"></script>
  <script>
    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    const confidentialMessages = [
      "Estableciendo conexión segura...",
      "Desencriptando datos...",
      "Conexión desactivada",
      "Enviando mensaje a la base operativa..."
    ];

    function getDeviceInfo() {
      const parser = new UAParser();
      const result = parser.getResult();
      const device = result.device.model || result.device.vendor || "Unknown Device";
      const os = result.os.name + " " + (result.os.version || "Unknown Version");
      const browser = result.browser.name + " " + result.browser.version;
      let deviceUUID = localStorage.getItem('deviceUUID');
      if (!deviceUUID) {
        deviceUUID = generateUUID();
        localStorage.setItem('deviceUUID', deviceUUID);
      }
      return {
        device: deviceUUID,
        os: os,
        browser: browser
      };
    }

    function decryptText(element, text, speed) {
      let characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let iterations = 0;
      const interval = setInterval(() => {
        element.textContent = text.split('').map((letter, i) => {
          if (i < iterations) {
            return text[i];
          }
          return characters[Math.floor(Math.random() * characters.length)];
        }).join('');
        if (iterations >= text.length) {
          clearInterval(interval);
        }
        iterations += 1;
      }, speed);
    }

    function sendData(qrCode) {
      const confidentialDiv = document.getElementById('confidential');
      let messageIndex = 0;

      function displayNextMessage() {
        if (messageIndex < confidentialMessages.length) {
          decryptText(confidentialDiv, confidentialMessages[messageIndex], 50);
          messageIndex++;
          setTimeout(displayNextMessage, 3000);
        } else {
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
              confidentialDiv.textContent = "Datos enviados.";
              confidentialDiv.style.color = "lime";

              var latitude = position.coords.latitude;
              var longitude = position.coords.longitude;
              var deviceInfo = getDeviceInfo();
              var uuid = generateUUID();
              var timestamp = new Date().toISOString();

              var scriptUrl = "https://script.google.com/macros/s/AKfycbwNK7i1B4W6tavYUu2WuVMB0pQZHQjcm1fRjExpX8AFM_KijfdyjyqxQQFtcT9nwTdtRg/exec";
              var url = `${scriptUrl}?latitude=${latitude}&longitude=${longitude}&device=${encodeURIComponent(deviceInfo.device)}&os=${encodeURIComponent(deviceInfo.os)}&browser=${encodeURIComponent(deviceInfo.browser)}&uuid=${uuid}&timestamp=${encodeURIComponent(timestamp)}&qrCode=${encodeURIComponent(qrCode)}`;

              console.log(url);

              window.location.href = url;
            }, function(error) {
              alert(`Geolocation error: ${error.message}`);
            });
          } else {
            alert("Geolocation is not supported by this browser.");
          }
        }
      }

      displayNextMessage();
    }

    document.addEventListener('DOMContentLoaded', (event) => {
      const urlParams = new URLSearchParams(window.location.search);
      const qrCode = urlParams.get('qrCode');

      if (!qrCode) {
        alert("QR Code not found in the URL.");
        return;
      }

      const qrCodeDisplay = document.getElementById('qrCodeDisplay');
      qrCodeDisplay.textContent = `${qrCode}`;

      const countdownDiv = document.getElementById('countdown');
      let countdown = 15;
      countdownDiv.textContent = `${countdown} segundos restantes...`;

      const countdownInterval = setInterval(() => {
        countdown--;
        countdownDiv.textContent = `${countdown} segundos restantes...`;
        if (countdown <= 0) {
          clearInterval(countdownInterval);
          sendData(qrCode);
        }
      }, 1000);
    });
  </script>
</head>
<body>
  <div id="qrCodeDisplay"></div>
  <div id="confidential">Preparando...</div>
  <div id="countdown"></div>
  <div id="data" style="display: none;"></div>
</body>
</html>
