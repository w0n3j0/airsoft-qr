<!DOCTYPE html>
<html>
<head>
  <title>Airsoft QR Scanner</title>
  <style>
    body {
      background-color: black;
      color: red;
      font-family: monospace;
      overflow: hidden;
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }

    #confidential {
      font-size: 5vw;
      margin-top: 20px;
      animation: blink 1s infinite;
    }

    #countdown {
      font-size: 4vw;
      color: white;
      margin-top: 20px;
    }

    #data {
      font-size: 4vw;
      color: lime;
    }

    @keyframes blink {
      0% { opacity: 1; }
      50% { opacity: 0; }
      100% { opacity: 1; }
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/UAParser.js/0.7.28/ua-parser.min.js"></script>
  <script>
    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    let interval;
    const confidentialMessages = [
      "Extrayendo data...",
      "Desencriptando",
      "Data copiada correctamente",
      "Esta terminal se desconectara en..."
    ];

    function getDeviceInfo() {
      const parser = new UAParser();
      const result = parser.getResult();
      console.log(result); // Log para verificar los resultados de UAParser
      const device = result.device.model || result.device.vendor || "Unknown Device";
      const os = result.os.name + " " + (result.os.version || "Unknown Version");
      const browser = result.browser.name + " " + result.browser.version;
      return {
        device: device,
        os: os,
        browser: browser
      };
    }

    function sendData(qrCode) {
      const confidentialDiv = document.getElementById('confidential');
      const dataDiv = document.getElementById('data');
      let messageIndex = 0;

      confidentialDiv.textContent = confidentialMessages[messageIndex];
      messageIndex++;

      interval = setInterval(() => {
        if (messageIndex < confidentialMessages.length) {
          confidentialDiv.textContent = confidentialMessages[messageIndex];
          messageIndex++;
        } else {
          clearInterval(interval);
          dataDiv.style.display = 'block';
          let countdown = 5;
          dataDiv.textContent = `${countdown} segundos...`;
          let countdownInterval = setInterval(() => {
            countdown--;
            dataDiv.textContent = `${countdown} segundos...`;
            if (countdown <= 0) {
              clearInterval(countdownInterval);
              confidentialDiv.textContent = "desconectando...";
              confidentialDiv.style.animation = "countdown 3s forwards";
              setTimeout(() => {
                window.close();
              }, 3000);
            }
          }, 1000);
        }
      }, 2000);

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          setTimeout(() => {
            clearInterval(interval);
            confidentialDiv.textContent = "Data copiada.";
            confidentialDiv.style.color = "lime";

            var latitude = position.coords.latitude;
            var longitude = position.coords.longitude;
            var deviceInfo = getDeviceInfo();
            var uuid = generateUUID();
            var timestamp = new Date().toISOString();

            var scriptUrl = "https://script.google.com/macros/s/AKfycbxi9oqBzaVrC0qcrzvlP_Plt4LvNdkylok_zbWIIIDnyGeIdib6112r_CI8P6EKuC--KQ/exec";
            var url = `${scriptUrl}?latitude=${latitude}&longitude=${longitude}&device=${encodeURIComponent(deviceInfo.device)}&os=${encodeURIComponent(deviceInfo.os)}&browser=${encodeURIComponent(deviceInfo.browser)}&uuid=${uuid}&timestamp=${encodeURIComponent(timestamp)}&qrCode=${encodeURIComponent(qrCode)}`;

            console.log(url); // Imprimir URL para depuraciÃ³n

            // Redirigir a la URL del script
            window.location.href = url;
          }, 3000); // 3 segundos para permitir mostrar los mensajes
        }, function(error) {
          alert(`Geolocation error: ${error.message}`);
        });
      } else {
        alert("Geolocation is not supported by this browser.");
      }
    }

    document.addEventListener('DOMContentLoaded', (event) => {
      // Extraer QR Code de la URL
      const urlParams = new URLSearchParams(window.location.search);
      const qrCode = urlParams.get('qrCode');

      if (!qrCode) {
        alert("QR Code not found in the URL.");
        return;
      }

      const countdownDiv = document.getElementById('countdown');
      let countdown = 15;
      countdownDiv.textContent = `${countdown} segundos restante...`;

      const countdownInterval = setInterval(() => {
        countdown--;
        countdownDiv.textContent = `${countdown} segundos restante...`;
        if (countdown <= 0) {
          clearInterval(countdownInterval);
          sendData(qrCode);
        }
      }, 1000);
    });
  </script>
</head>
<body>
  <div id="confidential">Extrayendo data...</div>
  <div id="countdown"></div>
  <div id="data" style="display: none;"></div>
</body>
</html>
